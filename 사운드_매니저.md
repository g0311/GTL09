### 사운드 시스템

- 개요
    - XAudio2 기반 사운드 재생 시스템
    - **책임 분리 아키텍처**
        - **USoundManager**: XAudio2 엔진 초기화 및 SourceVoice 생성 (싱글톤)
        - **USoundComponent**: 실제 사운드 재생 제어 (액터별 컴포넌트)
        - **USound**: WAV 파일 리소스 (ResourceManager가 캐싱 관리)
- 주요 컴포넌트
    - **USoundManager** (USoundManager.h:18-83)
        - XAudio2 엔진 초기화 및 종료
        - SourceVoice 생성 팩토리 역할
        - 전역 마스터 볼륨 제어
        - 사운드 리소스 프리로드
    - **USoundComponent** (SoundComponent.h:14-106)
        - 액터에 부착 가능한 사운드 컴포넌트
        - 각 컴포넌트가 독립적인 SourceVoice 소유
        - 재생/정지/일시정지/재개 제어
        - 자동 재생 및 루프 설정 지원
        - 개별 볼륨 제어
    - **USound** (Sound.h:6-26)
        - WAV 파일 로드 및 파싱
        - WAVEFORMATEXTENSIBLE 포맷 정보
        - XAUDIO2_BUFFER 버퍼 데이터
        - ResourceManager를 통한 캐싱

- USoundManager 초기화 프로세스 (USoundManager.cpp:30-68)
    1. COM 라이브러리 초기화
        - `CoInitializeEx(nullptr, COINIT_MULTITHREADED)`
    2. XAudio2 엔진 생성
        - `XAudio2Create(&XAudio2Engine, 0, XAUDIO2_DEFAULT_PROCESSOR)`
    3. 마스터링 보이스 생성
        - `XAudio2Engine->CreateMasteringVoice(&MasteringVoice)` → 최종 오디오 믹싱 출력
    4. 초기화 완료

    ```cpp
    // 게임 시작 시 초기화
    USoundManager& soundMgr = USoundManager::GetInstance();
    if (soundMgr.Initialize())
    {
        soundMgr.Preload(); // Sound/ 디렉토리의 모든 WAV 파일 로드
    }
    ```

- USoundManager 종료 프로세스 (USoundManager.cpp:71-93)
    1. 마스터링 보이스 파괴
        - `MasteringVoice->DestroyVoice()`
    2. XAudio2 엔진 해제
        - `XAudio2Engine->Release()`
    3. COM 해제
        - `CoUninitialize()`

- 리소스 프리로드 (USoundManager.cpp:95-147)
    - Sound/ 디렉토리를 재귀적으로 탐색
    - .wav 확장자 필터링 (대소문자 무시)
    - ResourceManager를 통해 모든 WAV 파일 캐싱
    - 중복 로딩 방지: `std::unordered_set<FString>` 사용

    ```cpp
    soundMgr.Preload(); // Sound/ 디렉토리의 모든 .wav 파일을 메모리에 로드
    ```

- SourceVoice 생성 (USoundManager.cpp:150-168)
    - USoundComponent가 재생 시 호출
    - USound의 WaveFormat을 사용하여 XAudio2 SourceVoice 생성
    - 반환된 SourceVoice는 호출자(Component)가 소유 및 관리

    ```cpp
    // USoundComponent 내부에서 호출
    IXAudio2SourceVoice* voice = USoundManager::GetInstance().CreateSourceVoice(Sound);
    ```

- 마스터 볼륨 제어 (USoundManager.cpp:171-178)
    - 전역 마스터 볼륨 설정 (0.0 ~ 1.0)
    - MasteringVoice에 적용되어 모든 사운드에 영향
    - 개별 사운드 볼륨 = `Component Volume × Master Volume`

    ```cpp
    soundMgr.SetMasterVolume(0.7f); // 모든 사운드 70% 볼륨
    ```

- USoundComponent 사용법
    - BeginPlay/EndPlay 자동 처리 (SoundComponent.cpp:41-58)
        - BeginPlay: bAutoPlay가 true면 자동 재생
        - EndPlay: SourceVoice 정리 및 메모리 해제
    - 재생 흐름 (SoundComponent.cpp:60-114)
        1. Sound 리소스 유효성 확인
        2. 기존 재생 중이면 Stop() 호출
        3. USoundManager에서 SourceVoice 생성
        4. 버퍼 설정 (루프: `XAUDIO2_LOOP_INFINITE` 또는 `0`)
        5. 버퍼 제출: `SourceVoice->SubmitSourceBuffer(&Buffer)`
        6. 볼륨 적용: `Volume × MasterVolume`
        7. 재생 시작: `SourceVoice->Start(0)`

    ```cpp
    // 코드에서 사운드 컴포넌트 추가
    USoundComponent* soundComp = actor->AddComponent<USoundComponent>();
    soundComp->SetSound(RESOURCE.Load<USound>("Sound/BGM/MainTheme.wav"));
    soundComp->SetLoop(true);
    soundComp->SetVolume(0.5f);
    soundComp->SetAutoPlay(true); // BeginPlay 시 자동 재생

    // 수동 제어
    soundComp->Play();    // 재생
    soundComp->Pause();   // 일시정지
    soundComp->Resume();  // 재개
    soundComp->Stop();    // 정지 및 SourceVoice 해제
    ```

- 재생 제어 함수
    - **Play()** (SoundComponent.cpp:60-114)
        - 기존 SourceVoice 정리
        - 새 SourceVoice 생성
        - 버퍼 제출 및 재생 시작
    - **Stop()** (SoundComponent.cpp:116-124)
        - `SourceVoice->Stop(0)` → 즉시 정지
        - `SourceVoice->DestroyVoice()` → 리소스 해제
        - `SourceVoice = nullptr` → 포인터 초기화
    - **Pause()** (SoundComponent.cpp:126-132)
        - `SourceVoice->Stop(0)` → 일시정지 (버퍼 유지)
        - SourceVoice는 유지됨 (Resume 가능)
    - **Resume()** (SoundComponent.cpp:134-140)
        - `SourceVoice->Start(0)` → 이어서 재생

- 볼륨 제어
    - **SetVolume(Volume)** (SoundComponent.cpp:142-152)
        - 컴포넌트 개별 볼륨 설정 (0.0 ~ 1.0)
        - 재생 중이면 즉시 적용
        - 최종 볼륨 = `Component Volume × Master Volume`

    ```cpp
    soundComp->SetVolume(0.5f);                      // 개별 50%
    USoundManager::GetInstance().SetMasterVolume(0.7f); // 전역 70%
    // → 실제 출력 볼륨: 0.5 × 0.7 = 0.35 (35%)
    ```

- 상태 확인
    - **IsPlaying()** (SoundComponent.cpp:154-164)
        - SourceVoice 존재 여부 확인
        - `SourceVoice->GetState(&State)` → 재생 상태 조회
        - `State.BuffersQueued > 0` → 재생 중
        - `State.BuffersQueued == 0` → 재생 완료 또는 정지됨

    ```cpp
    if (soundComp->IsPlaying())
    {
        soundComp->Stop(); // 재생 중이면 정지
    }
    ```

- 직렬화 및 에디터 연동
    - Serialize (SoundComponent.cpp:166-195)
        - 로드 시: "SoundAssetPath"에서 경로 읽고 ResourceManager로 로드
        - 저장 시: Sound 리소스의 파일 경로를 JSON에 저장
    - 리플렉션 프로퍼티 (SoundComponent.cpp:12-18)
        - Sound: 사운드 리소스 (에디터에서 선택 가능)
        - bAutoPlay: 자동 재생 여부
        - bLoop: 루프 재생 여부
        - Volume: 볼륨 크기 (0.0 ~ 1.0 슬라이더)

- 메모리 관리
    - **USoundComponent 소멸자** (SoundComponent.cpp:30-39)
        - SourceVoice 자동 정리
        - Stop + DestroyVoice + nullptr 처리
    - **EndPlay** (SoundComponent.cpp:52-58)
        - 액터 파괴 시 자동 호출
        - SourceVoice 해제로 메모리 누수 방지
    - **USound 소멸자** (Sound.cpp:13-16)
        - AudioData 벡터 자동 해제
        - ResourceManager가 생명주기 관리

- 아키텍처 장점
    - **명확한 책임 분리**
        - Manager: 엔진 초기화 (싱글톤, 전역 리소스)
        - Component: 재생 제어 (액터별, 독립적)
    - **독립적인 재생**
        - 각 컴포넌트가 자신의 SourceVoice 소유
        - 동시에 여러 사운드 재생 가능
        - 액터 삭제 시 자동 정리
    - **리소스 효율성**
        - USound는 ResourceManager가 캐싱
        - 여러 컴포넌트가 같은 USound 공유 가능
        - SourceVoice만 개별 생성
    - **확장성**
        - 3D 사운드 추가 시 Component만 확장
        - Manager는 변경 불필요

- 주요 파일 위치
    - **USoundManager**
        - 헤더: `Mundi/Source/Runtime/Engine/Sound/USoundManager.h`
        - 구현: `Mundi/Source/Runtime/Engine/Sound/USoundManager.cpp`
    - **USoundComponent**
        - 헤더: `Mundi/Source/Runtime/Engine/Components/SoundComponent.h`
        - 구현: `Mundi/Source/Runtime/Engine/Components/SoundComponent.cpp`
    - **USound**
        - 헤더: `Mundi/Source/Runtime/AssetManagement/Sound.h`
        - 구현: `Mundi/Source/Runtime/AssetManagement/Sound.cpp`
    - **사운드 리소스**: `Sound/` 디렉토리 (재귀 탐색)
